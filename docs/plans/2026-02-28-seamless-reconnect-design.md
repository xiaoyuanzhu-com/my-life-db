# Seamless Reconnect — Stable UUIDs + Merge-on-Reconnect

**Status: Implemented**

## Problem

When the WebSocket reconnects (network blip, visibility change, server restart), the frontend clears all `rawMessages` and rebuilds from the backend's burst. Every message component unmounts and remounts. This is visually disturbing, especially for visibility changes (switching apps) which happen frequently.

The full-refresh behavior was introduced as a workaround for a UUID deduplication bug: user messages have **two different UUIDs** — one generated by the backend (`uuid.New()` in the synthetic broadcast) and one generated by Claude CLI (written to JSONL). On server restart, JSONL loads with Claude's UUID, but the client has the backend's UUID. Dedup fails → duplicate user messages → full refresh was the fix.

## Root Cause

```
Backend creates synthetic user message:  UUID-A = uuid.New()
Claude CLI writes same message to JSONL: UUID-B = Claude's own UUID
UUID-A ≠ UUID-B → dedup fails on server restart
```

The backend's `SendUserMessage()` sends the user input to Claude CLI's stdin **without a UUID**. Claude CLI generates its own. Meanwhile, the backend independently generates a different UUID for the synthetic broadcast.

## Verified Fix

**Tested on Mac mini**: When a `uuid` field is included in the stdin JSON payload, Claude CLI **uses it** in the JSONL file. The UUID passes through.

```
Sent:    {"type":"user","uuid":"aaaaaaaa-bbbb-cccc-dddd-1772253298ee",...}
JSONL:   uuid=aaaaaaaa-bbbb-cccc-dddd-1772253298ee
>>> MATCH! Claude CLI USED our UUID!
```

## Design

### Part 1: Stable user message UUIDs

Generate the UUID **once** and pass it to both the synthetic broadcast and Claude CLI's stdin.

**Backend `api/claude.go`** — the WebSocket message handler:

```go
// Before: two independent UUIDs
session.SendInputUI(inMsg.Content)        // stdin: no UUID
syntheticMsg["uuid"] = uuid.New().String() // broadcast: UUID-A

// After: one UUID, two destinations
msgUUID := uuid.New().String()
session.SendInputUIWithUUID(inMsg.Content, msgUUID)  // stdin: msgUUID
syntheticMsg["uuid"] = msgUUID                        // broadcast: same msgUUID
```

**SDK chain** — thread UUID through:

| Layer | Current | New |
|-------|---------|-----|
| `session.go` | `SendInputUI(content)` | Add `SendInputUIWithUUID(content, uuid)` |
| `client.go` | `SendMessage(content)` | Add `SendMessageWithUUID(content, uuid)` |
| `query.go` | `SendUserMessage(content, sessionID)` | Add `uuid` param, include `"uuid": uuid` in stdin JSON |

**Result**: synthetic UUID = JSONL UUID. Stable across server restart.

### Part 2: Merge-on-reconnect

Replace the current clear-and-rebuild with UUID-based merge.

**Frontend `chat-interface.tsx`** — reconnect handler:

```
Current:
  reconnect → pendingReconnectClearRef = true
  first message → setRawMessages([])  // clear everything
  burst messages → rebuild from scratch

New:
  reconnect → set merge mode flag
  burst messages → merge into existing rawMessages by UUID:
    UUID exists → skip (no state change, no re-render)
    UUID new   → append
```

**State reset on reconnect** — keep rawMessages, reset only ephemeral state:
- ✅ Keep: `rawMessages` (stable, merge by UUID)
- Reset: `streamingText`, `streamingThinking`, `activeTodos`, `progressMessage`, `turnInProgress`
- Reset: `hasSeenInit` (re-detect historical/live boundary)
- Update: `lowestLoadedPage` from new `session_info`

## Changes

| File | What changes |
|------|-------------|
| `backend/api/claude.go` | Generate UUID once, pass to both stdin and broadcast |
| `backend/claude/session.go` | `SendInputUIWithUUID` |
| `backend/claude/sdk/client.go` | `SendMessageWithUUID(content, uuid)` |
| `backend/claude/sdk/query.go` | Include `uuid` in stdin JSON payload |
| `frontend/.../chat-interface.tsx` | Replace clear-on-reconnect with merge-by-UUID |

## Expected Behavior

| Scenario | Before | After |
|----------|--------|-------|
| Visibility change (switch apps) | Full re-render of all messages | Zero visual change |
| Network blip | Full re-render | Zero visual change |
| Server restart (same JSONL) | Full re-render | Zero visual change (UUIDs match) |
